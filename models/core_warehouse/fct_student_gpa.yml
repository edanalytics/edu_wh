version: 2

models:
  - name: fct_student_gpa
    description: >
      ##### Overview:
        Represents a historical record of student grade point averages, including cumulative and non-cumulative measures.

      ##### Primary Key:
        `k_student_academic_record, gpa_type, is_cumulative` -- There is one record per student, education organization (usually school 
        or LEA), academic term, GPA type (such as weighted or unweighted), and cumulative/non-cumulative indicator.

      ##### Important Business Rules:
        `k_student` is an annualized student identifier, so it will be null unless there is a student record for the relevant school year.

      ##### Example Use Cases:
        To join to `dim_student` without dropping the records where `k_student` is null (i.e., those without `dim_student` data for the
        year of the GPA record), it is necessary to join on `k_student_xyear` and include some logic to determine which year of student 
        data should be used. One way to do this is using the `is_latest_record` indicator. For example, if a student was most recently
        enrolled in 2021, then all GPA records - regardless of the year of the data - will be joined to the 2021 `dim_student` record. 
        ```
        SELECT *
        FROM analytics.prod_wh.fct_student_gpa
        LEFT JOIN analytics.prod_wh.dim_student
          ON fct_student_gpa.k_student_xyear = dim_student.k_student_xyear
        WHERE dim_student.is_latest_record = True
        ```

    config:
      tags: ['core']
      contract: {enforced: true}
    constraints:
      - type: primary_key
        columns: [k_student_academic_record, gpa_type, is_cumulative]
        warn_unenforced: false
      - type: not_null
        columns: [k_student_academic_record, gpa_type, is_cumulative]
      - type: foreign_key
        columns: [k_student_academic_record]
        expression: "{{ target.schema }}_wh.fct_student_academic_record (k_student_academic_record)"
        warn_unenforced: false
      - type: foreign_key
        columns: [k_student]
        expression: "{{ target.schema }}_wh.dim_student (k_student)"
        warn_unenforced: false
    columns:
      - name: k_student_academic_record
        data_type: string
      - name: k_student_xyear
        data_type: string
        description: Defining key for the student, which is consistent across years.
      - name: k_student
        data_type: string
        description: Defining key for the student in this school year.
      - name: k_lea
        data_type: string
      - name: k_school
        data_type: string
      - name: tenant_code
        data_type: string
      - name: school_year
        data_type: int
      - name: academic_term
        data_type: string
      - name: gpa_type
        data_type: string
        description: The system used for calculating the grade point average for an individual.
      - name: gpa_value
        data_type: float
        description: The value of the grade points earned divided by the number of credits attempted.
      - name: is_cumulative
        data_type: boolean
        description: Indicator of whether or not the Grade Point Average value is cumulative.
      - name: max_gpa_value
        data_type: float
        description: The maximum value for the grade point average.